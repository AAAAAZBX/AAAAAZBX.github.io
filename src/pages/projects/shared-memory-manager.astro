---
import Layout from "../../layouts/Layout.astro";
import TableOfContents from "../../components/TableOfContents.astro";
---

<Layout title="Shared Memory Manager | Projects">
  <div class="article-wrapper">
    <TableOfContents />
    <div class="article-content">
      <article class="typora-github">
        <h1>🔗 Shared Memory Manager</h1>
        
        <div style="margin: 20px 0; padding: 16px; background-color: #f6f8fa; border-radius: 6px; border-left: 4px solid #0969da;">
          <p style="margin: 0 0 12px 0; font-size: 16px;">
            <strong>一个基于 Python 的跨网络共享内存管理工具，支持 GUI 界面和 TCP 协议通信</strong>
          </p>
          <div style="display: flex; gap: 16px; flex-wrap: wrap;">
            <a 
              href="https://github.com/AAAAAZBX/Shared-Memory-Manager" 
              target="_blank" 
              rel="noopener noreferrer"
              style="display: inline-flex; align-items: center; gap: 6px; color: #0969da; text-decoration: none; font-weight: 500;"
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
              </svg>
              View on GitHub
            </a>
            <span style="color: #57606a; display: inline-flex; align-items: center; gap: 4px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              Python
            </span>
          </div>
        </div>

        <h2>✨ 特性</h2>
        <ul>
          <li><strong>🖥️ 图形化界面</strong> - 友好的 GUI 界面，支持 Host 和 Client 模式切换</li>
          <li><strong>🌐 跨网络访问</strong> - 支持本地和远程访问，自动模式切换</li>
          <li><strong>🔒 原子性操作</strong> - 基于锁机制的原子性读写，保证数据一致性</li>
          <li><strong>🔄 实时同步</strong> - 输入框实时显示共享内存内容，自动同步更新</li>
          <li><strong>📡 TCP 协议</strong> - 跨网络时通过 TCP 协议通信，Host 在本地操作共享内存</li>
          <li><strong>🧩 模块化设计</strong> - 代码结构清晰，易于维护和扩展</li>
          <li><strong>⚡ 零依赖</strong> - 仅使用 Python 标准库，无需安装第三方包</li>
        </ul>

        <h2>🚀 快速开始</h2>
        
        <h3>环境要求</h3>
        <ul>
          <li>Python 3.8 或更高版本</li>
          <li>Windows 操作系统</li>
        </ul>

        <h3>安装</h3>
        <pre><code># 克隆仓库
git clone https://github.com/AAAAAZBX/Shared-Memory-Manager.git
cd Shared-Memory-Manager

# 无需安装依赖，直接运行即可
python GUI.py</code></pre>
        <p>💡 <strong>提示</strong>: 本项目仅使用 Python 标准库，无需安装任何第三方包</p>

        <h2>🎯 功能特性</h2>

        <h3>本地访问模式</h3>
        <ul>
          <li>Host 和 Client 在同一台机器上</li>
          <li>Client 直接访问共享内存，性能最优</li>
          <li>支持实时同步和自动刷新</li>
        </ul>

        <h3>远程访问模式</h3>
        <ul>
          <li>Host 和 Client 在不同机器上</li>
          <li>通过 TCP 协议进行通信</li>
          <li>自动检测并切换模式</li>
          <li>支持跨网络数据同步</li>
        </ul>

        <h3>核心功能</h3>
        <ul>
          <li>✅ 共享内存创建和管理</li>
          <li>✅ 原子性读写操作</li>
          <li>✅ 自动锁机制（写入时上锁，完成后立即释放）</li>
          <li>✅ 实时内容同步</li>
          <li>✅ 网络连接管理</li>
          <li>✅ 错误处理和超时机制</li>
        </ul>

        <h2>📁 项目结构</h2>
        <pre><code>Shared_Memory/
├── GUI.py                    # GUI 主程序（界面和交互逻辑）
├── shared_memory_utils.py    # 共享内存工具模块（底层操作）
├── requirements.txt          # 依赖说明（仅标准库）
├── README.md                 # 项目文档
└── .gitignore               # Git 忽略配置</code></pre>

        <h3>模块说明</h3>
        <ul>
          <li><strong><code>GUI.py</code></strong>: 图形界面主程序
            <ul>
              <li><code>SharedMemoryGUI</code> 类：主界面和事件处理</li>
              <li>Host 和 Client 模式管理</li>
              <li>网络连接和自动刷新</li>
            </ul>
          </li>
          <li><strong><code>shared_memory_utils.py</code></strong>: 工具模块
            <ul>
              <li><code>SharedMemoryLock</code> 类：锁机制实现</li>
              <li><code>shm_write()</code>: 原子性写入函数</li>
              <li><code>shm_read()</code>: 读取共享内存函数</li>
              <li><code>get_local_ip()</code>: 获取本机 IP 地址</li>
            </ul>
          </li>
        </ul>

        <h2>🔧 技术实现</h2>

        <h3>共享内存布局</h3>
        <p>本实现采用以下内存布局（总大小 4096 字节）：</p>
        <pre><code>偏移量    大小    内容
─────────────────────────────────────
0         1       lock_flag    (锁标志: 0=空闲, 1=占用)
1-4       4       str_len      (字符串长度，uint32，小端序)
5-4095    4091    data         (UTF-8 编码的字符串数据)</code></pre>
        <p><strong>关键常量</strong>：</p>
        <ul>
          <li><code>LOCK_SIZE = 1</code>: 锁标志占用 1 字节</li>
          <li><code>LEN_SIZE = 4</code>: 长度字段占用 4 字节</li>
          <li><code>DATA_OFFSET = 5</code>: 数据起始偏移</li>
          <li><code>BUF_SIZE = 4096</code>: 共享内存总大小</li>
          <li><code>MAX_DATA_SIZE = 4091</code>: 最大数据长度</li>
        </ul>

        <h3>锁机制</h3>
        <p>采用整块锁机制，保证读写操作的原子性：</p>
        <ul>
          <li><strong>锁位置</strong>: 共享内存的第一个字节（偏移 0）</li>
          <li><strong>锁状态</strong>:
            <ul>
              <li><code>LOCK_FREE = 0</code>: 锁空闲</li>
              <li><code>LOCK_HELD = 1</code>: 锁被占用</li>
            </ul>
          </li>
          <li><strong>特性</strong>:
            <ul>
              <li>写入时自动上锁，完成后立即释放</li>
              <li>支持超时机制（默认 5 秒）</li>
              <li>原子性检查，防止竞争条件</li>
            </ul>
          </li>
        </ul>

        <h3>网络通信协议</h3>
        
        <h4>本地模式</h4>
        <ul>
          <li>Client 直接访问共享内存</li>
          <li>无需网络传输，性能最优</li>
        </ul>

        <h4>远程模式（TCP 协议）</h4>
        <p><strong>READ 命令</strong>（读取共享内存内容）</p>
        <pre><code>Client → Host: READ\n
Host → Client: OK &lt;content&gt;\n 或 ERROR &lt;message&gt;\n</code></pre>
        
        <p><strong>WRITE 命令</strong>（写入共享内存内容）</p>
        <pre><code>Client → Host: WRITE &lt;length&gt;\n&lt;content&gt;\n
Host → Client: OK\n 或 ERROR &lt;message&gt;\n</code></pre>

        <h2>📖 使用指南</h2>

        <h3>基本使用流程</h3>

        <h4>1️⃣ 启动 Host</h4>
        <ol>
          <li>运行程序：<code>python GUI.py</code></li>
          <li>选择 <strong>"Host（主机）"</strong> 模式</li>
          <li>点击 <strong>"启动 Host"</strong> 按钮</li>
          <li>记录显示的连接信息：
            <ul>
              <li>本机 IP</li>
              <li>端口号</li>
              <li>共享内存 ID</li>
            </ul>
          </li>
        </ol>

        <h4>2️⃣ 启动 Client</h4>
        <ol>
          <li>运行程序：<code>python GUI.py</code>（可在同一台或另一台机器上）</li>
          <li>选择 <strong>"Client（客户端）"</strong> 模式</li>
          <li>输入连接信息：
            <ul>
              <li>Host IP（本地访问可使用 <code>127.0.0.1</code>）</li>
              <li>端口号</li>
              <li>共享内存 ID</li>
            </ul>
          </li>
          <li>点击 <strong>"连接 Host"</strong> 按钮</li>
          <li>连接成功后，输入框会自动显示共享内存内容</li>
        </ol>

        <h4>3️⃣ 读写操作</h4>
        <p><strong>读取</strong>：</p>
        <ul>
          <li>输入框会自动同步显示共享内存内容</li>
          <li>每 500ms 自动刷新一次</li>
          <li>无需手动操作</li>
        </ul>
        
        <p><strong>写入</strong>：</p>
        <ol>
          <li>在输入框中编辑内容（最大 4091 字节）</li>
          <li>点击 <strong>"写入共享内存"</strong> 按钮</li>
          <li>系统自动上锁 → 写入 → 释放锁</li>
          <li>内容自动同步到对方主机</li>
        </ol>

        <h2>💡 技术要点</h2>
        <table>
          <thead>
            <tr>
              <th>特性</th>
              <th>说明</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>内存布局</strong></td>
              <td>锁标志(1字节) + 长度(4字节) + 数据(剩余空间)</td>
            </tr>
            <tr>
              <td><strong>锁机制</strong></td>
              <td>整块锁，写入时自动上锁，完成后立即释放</td>
            </tr>
            <tr>
              <td><strong>原子性</strong></td>
              <td>所有写操作在锁保护下执行，保证原子性</td>
            </tr>
            <tr>
              <td><strong>网络容错</strong></td>
              <td>支持超时机制，处理网络抖动</td>
            </tr>
            <tr>
              <td><strong>跨进程通信</strong></td>
              <td>使用 multiprocessing.shared_memory 实现</td>
            </tr>
            <tr>
              <td><strong>协议设计</strong></td>
              <td>基于 TCP 的简单文本协议，易于调试</td>
            </tr>
            <tr>
              <td><strong>跨网络支持</strong></td>
              <td>自动检测本地/远程模式，智能切换</td>
            </tr>
            <tr>
              <td><strong>模块化设计</strong></td>
              <td>GUI 和工具模块分离，便于维护</td>
            </tr>
            <tr>
              <td><strong>实时同步</strong></td>
              <td>输入框实时显示，自动覆盖更新</td>
            </tr>
          </tbody>
        </table>

        <h2>⚠️ 注意事项</h2>

        <h3>系统要求</h3>
        <ul>
          <li>✅ Python 3.8+（<code>multiprocessing.shared_memory</code> 需要 Python 3.8+）</li>
          <li>✅ Windows 操作系统（已在 Windows 上测试通过）</li>
          <li>✅ 网络互通（跨网络访问时）</li>
        </ul>

        <h3>使用限制</h3>
        <ul>
          <li>📝 <strong>数据长度</strong>: 最大 4091 字节（4096 - 5）</li>
          <li>🔒 <strong>锁超时</strong>: 默认 5 秒，超时后抛出异常</li>
          <li>🌐 <strong>网络</strong>: 跨网络访问需要防火墙允许 TCP 连接</li>
          <li>📂 <strong>文件依赖</strong>: <code>GUI.py</code> 和 <code>shared_memory_utils.py</code> 必须在同一目录</li>
        </ul>

        <h2>📚 项目背景</h2>
        <p>本项目旨在实现一个跨网络的共享内存管理系统，解决以下技术难点：</p>

        <h3>1. 内存不稳定问题</h3>
        <p><strong>问题</strong>：</p>
        <ul>
          <li>内存生命周期管理</li>
          <li>重启/崩溃后内存编号映射恢复</li>
          <li>内存换入/换出，位置不固定</li>
        </ul>
        <p><strong>解决方案</strong>：</p>
        <ul>
          <li>使用 <code>multiprocessing.shared_memory</code> 管理内存生命周期</li>
          <li>通过 shm_id 进行内存映射</li>
          <li>内存位置由操作系统管理</li>
        </ul>

        <h3>2. 并发读写一致性</h3>
        <p><strong>问题</strong>：</p>
        <ul>
          <li>多个客户端同时读写时的数据一致性</li>
          <li>需要锁机制保证原子性</li>
          <li>锁粒度选择（整块锁 vs 分段锁）</li>
        </ul>
        <p><strong>解决方案</strong>：</p>
        <ul>
          <li>实现整块锁机制（简单高效）</li>
          <li>写入时自动上锁，完成后立即释放</li>
          <li>支持超时机制，避免死锁</li>
        </ul>

        <h3>3. 网络抖动问题</h3>
        <p><strong>问题</strong>：</p>
        <ul>
          <li>网络断线、重连、超时</li>
          <li>重复写操作的原子性保证</li>
        </ul>
        <p><strong>解决方案</strong>：</p>
        <ul>
          <li>TCP 协议保证可靠传输</li>
          <li>超时机制处理网络延迟</li>
          <li>锁机制保证写操作的原子性</li>
        </ul>

        <hr style="margin: 40px 0;" />

        <p style="text-align: center; color: #57606a;">
          <strong>如果这个项目对你有帮助，请给个 ⭐ Star！</strong>
        </p>
        <p style="text-align: center; margin-top: 8px;">
          <a href="https://github.com/AAAAAZBX/Shared-Memory-Manager" target="_blank" rel="noopener noreferrer" style="color: #0969da; text-decoration: none;">
            https://github.com/AAAAAZBX/Shared-Memory-Manager
          </a>
        </p>
      </article>
    </div>
  </div>
</Layout>
