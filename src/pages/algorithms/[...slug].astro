---
import Layout from "../../layouts/Layout.astro";
import { getCollection, getEntry } from "astro:content";
import TableOfContents from "../../components/TableOfContents.astro";
import WalineComment from "../../components/WalineComment.astro";

export async function getStaticPaths() {
  const posts = await getCollection("algorithms");
  const paths = [];
  
  posts.forEach((post) => {
    // 生成完整路径的路由（对于 [...slug]，直接使用字符串）
    paths.push({
      params: { slug: post.slug },
    });
    
    // 生成只有文件名的路由
    const slugParts = post.slug.split('/');
    const fileName = slugParts[slugParts.length - 1];
    // 只有当文件名与完整路径不同时才添加
    if (fileName !== post.slug) {
      paths.push({
        params: { slug: fileName },
      });
    }
  });
  
  return paths;
}

const { slug } = Astro.params;
// 对于 [...slug]，slug 是数组，需要转换为字符串
const slugArray = Array.isArray(slug) ? slug : [slug];
const slugString = slugArray.join('/');

// 获取所有文章
const allPosts = await getCollection("algorithms");

// 查找文章：先尝试完整路径，再尝试文件名
let post = allPosts.find(p => p.slug === slugString);

if (!post) {
  // 如果完整路径找不到，尝试通过文件名查找
  const fileName = slugArray[slugArray.length - 1];
  post = allPosts.find(p => {
    const postSlugParts = p.slug.split('/');
    const postFileName = postSlugParts[postSlugParts.length - 1];
    return postFileName === fileName;
  });
}

if (!post) {
  return new Response(null, {
    status: 404,
    statusText: 'Not found'
  });
}

const { Content } = await post.render();
---

<Layout title={`${post.data.title} | Competitive Programming`}>
  <div class="article-wrapper">
    <TableOfContents />
    <div class="article-content">
      <article class="typora-github">
      <h1>{post.data.title}</h1>
        <Content />
      </article>
      
      <!-- 评论区域 -->
      <div style="margin-top: 60px; padding-top: 40px; border-top: 1px solid #d0d7de;">
        <WalineComment />
      </div>
    </div>
  </div>
</Layout>

