---
// TableOfContents 组件：自动生成文章目录
---

<div id="toc-container" class="toc-container">
  <div class="toc-header">
    <h3>目录</h3>
  </div>
  <nav id="toc-nav" class="toc-nav">
    <!-- 目录项将通过 JavaScript 动态生成 -->
  </nav>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const article = document.querySelector("article.typora-github");
    if (!article) return;

    const titleHeading = article.querySelector("h1");
    const headings = Array.from(article.querySelectorAll("h1, h2, h3, h4")).filter(
      (heading) => heading !== titleHeading
    ) as HTMLElement[];
    if (headings.length === 0) {
      document.getElementById("toc-container")?.remove();
      return;
    }

    const tocNav = document.getElementById("toc-nav");
    if (!tocNav) return;

    const tocItems = [];

    const getScrollOffset = () => {
      const header = document.querySelector("header");
      const headerHeight = header ? header.getBoundingClientRect().height : 0;
      return headerHeight + 16;
    };

    const setActiveById = (id: string | undefined | null) => {
      if (!id) return;
      tocNav.querySelectorAll("a.toc-item").forEach((link) => {
        const listItem = link.closest(".toc-list-item");
        link.classList.remove("active");
        listItem?.classList.remove("active");
        if (link.getAttribute("href") === `#${id}`) {
          link.classList.add("active");
          listItem?.classList.add("active");
        }
      });
    };

    headings.forEach((heading, index) => {
      // 为每个标题生成 ID
      const text = heading.textContent || "";
      let id = text
        .toLowerCase()
        .replace(/[^\w\s\u4e00-\u9fa5-]/g, "") // 保留中文、英文、数字、连字符
        .replace(/\s+/g, "-")
        .replace(/-+/g, "-")
        .trim();
      
      // 如果 ID 为空或已存在，添加索引
      if (!id) {
        id = `heading-${index}`;
      }
      
      // 检查是否已存在相同 ID
      let finalId = id;
      let counter = 1;
      while (document.getElementById(finalId)) {
        finalId = `${id}-${counter}`;
        counter++;
      }

      heading.id = finalId;
      const level = parseInt(heading.tagName.charAt(1));
      tocItems.push({ id: finalId, text, level });
    });

    // 生成扁平结构的目录 HTML，使用 padding-left 来缩进
    let tocHTML = '<ul class="toc-list">';
    const baseLevel = Math.min(...tocItems.map((item) => item.level));
    
    tocItems.forEach((item) => {
      const level = item.level;
      const levelClass = `toc-level-${level}`;
      // 根据级别计算缩进：从当前文章的最小标题级别开始计算（每级增加18px，更紧凑）
      const indent = (level - baseLevel) * 18;
      // 使用 CSS 变量传递缩进，避免被全局样式覆盖
      tocHTML += `<li class="toc-list-item ${levelClass}" style="--indent: ${indent}px;">`;
      tocHTML += `<a href="#${item.id}" class="toc-item">${item.text}</a>`;
      tocHTML += '</li>';
    });
    
    tocHTML += '</ul>';
    tocNav.innerHTML = tocHTML;

    // 添加平滑滚动（使用事件委托，因为结构是动态生成的）
    tocNav.addEventListener("click", (e) => {
      const link = e.target.closest("a.toc-item");
      if (!link) return;
      
      e.preventDefault();
      const targetId = link.getAttribute("href")?.substring(1);
      const target = document.getElementById(targetId || "");
      if (target) {
        const offset = getScrollOffset();
        const top = target.getBoundingClientRect().top + window.pageYOffset - offset;
        window.scrollTo({ top, behavior: "smooth" });
        // 使用 replaceState 而不是 pushState，避免在历史记录中留下锚点
        // 这样回退时会回到上一个网页，而不是上一个标题
        const url = window.location.pathname + (targetId ? `#${targetId}` : '');
        window.history.replaceState(null, "", url);

        setActiveById(targetId);
      }
    });

    const updateActiveFromScroll = () => {
      const offset = getScrollOffset();
      const scrollPos = window.pageYOffset + offset + 1;

      let currentId = "";
      for (const heading of headings) {
        if (!heading.id) continue;
        if (heading.offsetTop <= scrollPos) {
          currentId = heading.id;
        } else {
          break;
        }
      }

      if (!currentId && headings[0]?.id) currentId = headings[0].id;
      if (currentId) setActiveById(currentId);
    };

    // 初始状态：如果有 hash，优先高亮 hash；否则按滚动位置高亮
    const initialHash = window.location.hash;
    if (initialHash && initialHash.startsWith("#")) {
      setActiveById(initialHash.substring(1));
    } else {
      updateActiveFromScroll();
    }

    // 滚动时高亮当前章节（使用 requestAnimationFrame 节流）
    let scrollTicking = false;
    const onScroll = () => {
      if (scrollTicking) return;
      scrollTicking = true;
      window.requestAnimationFrame(() => {
        updateActiveFromScroll();
        scrollTicking = false;
      });
    };
    window.addEventListener("scroll", onScroll, { passive: true });

    // 监听浏览器前进/后退
    window.addEventListener("popstate", () => {
      const hash = window.location.hash;
      if (hash && hash.startsWith("#")) {
        setActiveById(hash.substring(1));
      } else {
        updateActiveFromScroll();
      }
      // 如果有锚点，滚动到对应位置
      if (hash) {
        const target = document.getElementById(hash.substring(1));
        if (target) {
          const offset = getScrollOffset();
          const top = target.getBoundingClientRect().top + window.pageYOffset - offset;
          window.scrollTo({ top, behavior: "smooth" });
        }
      }
    });
  });
</script>

<style is:global>
  /* 完全重写目录样式 - 知乎风格 */
  
  /* 容器样式 */
  #toc-container.toc-container {
    position: sticky;
    top: 80px;
    max-height: calc(100vh - 100px);
    overflow-y: auto;
    overflow-x: visible !important; /* 强制 visible，让圆点可以超出容器边界显示 */
    margin-right: 32px;
    flex-shrink: 0;
    width: 240px;
    background: transparent;
    border: none;
    border-radius: 0;
    padding: 16px;
    padding-left: 30px !important; /* 增加左侧 padding，确保最大的圆点（7px，left: -3px）也能完整显示 */
    box-shadow: none;
    /* 确保容器本身不会裁剪内容 */
    clip-path: none !important;
    clip: auto !important;
  }

  /* 标题区域 */
  #toc-container .toc-header {
    margin-bottom: 12px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e1e4e8;
  }

  #toc-container .toc-header h3 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: #24292f;
  }

  /* 导航区域 - 带垂直连接线（参考知乎实现） */
  /* 添加 padding-left 让圆点完整显示 */
  #toc-container .toc-nav {
    position: relative;
    padding-left: 0; /* 不需要额外的 padding，因为容器已经有 padding-left 了 */
  }

  /* 主垂直连接线 - 知乎风格：竖线在背景层 */
  /* 竖线位置：容器 padding-left 是 20px，但我们需要竖线在合适的位置 */
  /* 考虑到圆点中心要对齐，竖线应该在合适的位置 */
  #toc-container .toc-nav::before {
    content: '';
    position: absolute;
    left: 0; /* 相对于 .toc-nav，从 0 开始 */
    top: 0;
    bottom: 0;
    width: 1px;
    background-color: #e1e4e8;
    z-index: 0;
  }

  /* 列表基础样式 */
  /* 关键：设置 z-index，确保整个列表（包括圆点）在竖线上方 */
  #toc-container .toc-nav > ul,
  #toc-container .toc-list {
    list-style: none !important;
    padding: 0 !important;
    margin: 0 !important;
    position: relative;
    z-index: 1;
  }

  #toc-container .toc-list-item {
    margin: 0 !important;
    position: relative;
    list-style: none !important;
    z-index: 1;
    padding-left: var(--indent, 0px) !important;
  }

  /* 圆形标记点 - 纯色圆点，浮在竖线上方 */
  /* 关键：竖线在 .toc-nav 的 left: 0，中心在 0.5px
     圆点的 left 是相对于 .toc-list-item 的
     圆点中心要对齐到竖线中心 0.5px
     圆点宽度6px，中心在 0.5px，所以 left = 0.5 - 3 = -2.5px */
  #toc-container .toc-list-item::before {
    content: '';
    position: absolute;
    left: -2.5px; /* 圆点宽度6px，中心在0.5px（相对于.toc-list-item），所以 left = 0.5 - 3 = -2.5px */
    top: 50%;
    transform: translateY(-50%);
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: #8491A5;
    border: none;
    z-index: 2 !important;
    transition: background-color 0.2s;
    box-sizing: border-box;
  }

  /* h1 级别 - 最大的圆点 */
  #toc-container .toc-level-1::before {
    width: 8px !important;
    height: 8px !important;
    left: -3.5px !important; /* 圆点宽度8px，中心在0.5px，所以 left = 0.5 - 4 = -3.5px */
    border: none !important;
  }

  /* h2 级别 - 次大的圆点 */
  #toc-container .toc-level-2::before {
    width: 7px !important;
    height: 7px !important;
    left: -3px !important; /* 圆点宽度7px，中心在0.5px，所以 left = 0.5 - 3.5 = -3px */
    border: none !important;
  }

  /* h3 级别 - 中等圆点（默认，已在上面定义） */
  #toc-container .toc-level-3::before {
    width: 6px !important;
    height: 6px !important;
    left: -2.5px !important; /* 圆点宽度6px，中心在0.5px，所以 left = 0.5 - 3 = -2.5px */
    border: none !important;
  }

  /* h4 级别 - 最小的圆点 */
  #toc-container .toc-level-4::before {
    width: 5px !important;
    height: 5px !important;
    left: -2px !important; /* 圆点宽度5px，中心在0.5px，所以 left = 0.5 - 2.5 = -2px */
    border: none !important;
  }

  /* 激活状态的标记点变蓝 */
  #toc-container .toc-list-item.active::before {
    background-color: #1890ff !important;
    box-shadow: 0 1px 3px rgba(24, 144, 255, 0.3) !important;
  }

  /* 链接样式 - 强制覆盖所有状态 */
  #toc-container .toc-item {
    all: unset;
    display: block !important;
    padding: 6px 0 !important;
    font-size: 13px !important;
    color: #8590a6 !important;
    text-decoration: none !important;
    text-decoration-line: none !important;
    cursor: pointer !important;
    line-height: 1.6 !important;
    position: relative !important;
    transition: color 0.2s !important;
    background: transparent !important;
    border: none !important;
    outline: none !important;
  }

  /* 所有链接状态都设为灰色 - 使用 !important 强制覆盖 */
  #toc-container .toc-item:link,
  #toc-container .toc-item:visited,
  #toc-container .toc-item:hover,
  #toc-container .toc-item:active,
  #toc-container .toc-item:focus {
    color: #8590a6 !important;
    text-decoration: none !important;
    text-decoration-line: none !important;
    background-color: transparent !important;
  }

  /* 不同层级 - 设置字体和文本缩进 */
  #toc-container .toc-level-2 .toc-item {
    font-weight: 500;
    font-size: 14px;
    text-indent: 0; /* h2 不缩进 */
  }

  #toc-container .toc-level-3 .toc-item {
    font-weight: 400;
    font-size: 13px;
    text-indent: 4px; /* h3 缩进 4px */
  }

  #toc-container .toc-level-4 .toc-item {
    font-weight: 400;
    font-size: 12px;
    text-indent: 8px; /* h4 缩进 8px */
  }
  
  /* 确保链接文本从圆圈右边开始，有适当间距，并处理文本溢出 */
  #toc-container .toc-item {
    padding-left: 12px !important; /* 圆圈和文字之间的间距，确保文字不会和圆圈重叠 */
    padding-right: 8px !important; /* 右边留点空间 */
    margin-left: 0 !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    white-space: nowrap !important;
    display: block !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
  }
  
  /* 确保 li 元素不会超出容器 */
  #toc-container .toc-list-item {
    max-width: 100% !important;
    overflow: visible !important; /* 改为 visible，让圆点可以超出边界显示 */
  }
  
  /* 激活状态 - 蓝色 - 最高优先级 */
  #toc-container .toc-item.active,
  #toc-container .toc-item.active:link,
  #toc-container .toc-item.active:visited,
  #toc-container .toc-item.active:hover,
  #toc-container .toc-item.active:active,
  #toc-container .toc-item.active:focus {
    color: #1890ff !important;
    font-weight: 500 !important;
    text-decoration: none !important;
    text-decoration-line: none !important;
    background-color: transparent !important;
  }

  /* 移动端隐藏 */
  @media (max-width: 1024px) {
    #toc-container.toc-container {
      display: none;
    }
  }

  /* 滚动条 */
  #toc-container.toc-container::-webkit-scrollbar {
    width: 6px;
  }

  #toc-container.toc-container::-webkit-scrollbar-track {
    background: transparent;
  }

  #toc-container.toc-container::-webkit-scrollbar-thumb {
    background: #d1d9e0;
    border-radius: 3px;
  }

  #toc-container.toc-container::-webkit-scrollbar-thumb:hover {
    background: #a8b2bc;
  }
</style>

